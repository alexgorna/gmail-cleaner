<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox Analyzer</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #f0f4f8;
            --hero-gradient-start: #e3f2fd;
            --hero-gradient-end: #bbdefb;
            --accent-color: #0d6efd;
        }
        body { background-color: var(--primary-bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color: #333; }
        
        /* Navbar */
        .navbar { background-color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 0 0 1px #dee2e6; }
        
        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, var(--hero-gradient-start) 0%, var(--hero-gradient-end) 100%);
            padding: 60px 20px 80px 20px;
            text-align: center;
            border-bottom: 1px solid #dbeafe;
        }
        .hero-title { font-size: 2rem; font-weight: 300; color: #1e293b; margin-bottom: 0; }
        .hero-count { font-weight: 700; color: var(--accent-color); }
        
        /* Main Card */
        .dashboard-container {
            margin-top: -50px;
            padding: 0 20px;
            margin-bottom: 50px;
        }
        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
            overflow: hidden;
        }

        /* Controls */
        .controls-wrapper { padding: 20px; border-bottom: 1px solid #f1f5f9; background-color: #fff; min-height: 85px; }
        
        /* Search Group */
        .search-input-group { max-width: 500px; width: 100%; position: relative; }
        .search-input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; z-index: 5; }
        .search-input-group input { padding-left: 40px; border-radius: 50px; background-color: #f8fafc; border: 1px solid #e2e8f0; height: 45px; }
        .search-input-group input:focus { background-color: #fff; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); border-color: var(--accent-color); }
        
        /* Bulk Actions Group */
        .bulk-actions-group { display: none; align-items: center; gap: 12px; animation: fadeIn 0.2s ease; }
        .btn-bulk-delete { border-color: #dc3545; color: #dc3545; border-radius: 20px; background: white; padding: 8px 16px; font-weight: 500; font-size: 0.9rem; }
        .btn-bulk-delete:hover { background-color: #dc3545; color: white; }
        .btn-bulk-label { border-color: #6c757d; color: #495057; border-radius: 20px; background: white; padding: 8px 16px; font-weight: 500; font-size: 0.9rem; }
        .btn-bulk-label:hover { background-color: #f8f9fa; color: #212529; }
        
        /* Table */
        .table-custom th { background-color: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 16px; border-bottom: 1px solid #e2e8f0; }
        .table-custom td { vertical-align: middle; padding: 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .table-custom tr:hover td { background-color: #f8fafc; }
        .table-custom .email-text { font-weight: 500; color: #0f172a; }
        .count-badge { 
            background-color: #dbeafe; color: #1e40af; 
            padding: 6px 12px; border-radius: 20px; 
            font-size: 0.85rem; font-weight: 600; display: inline-block; min-width: 40px; text-align: center;
        }

        /* Processed Row Style */
        .row-processed { opacity: 0.5; background-color: #f8f9fa; pointer-events: none; }
        .row-processed .email-text { text-decoration: line-through; color: #999; }
        .row-processed .action-select { background-color: #e9ecef; border-color: #dee2e6; color: #6c757d; }
        
        /* Action Select */
        .action-select {
            border-radius: 20px; border: 1px solid #cbd5e1; background-color: #fff; 
            font-size: 0.9rem; padding: 6px 30px 6px 12px; cursor: pointer;
            transition: all 0.2s;
        }
        .action-select:hover { border-color: #94a3b8; background-color: #f8fafc; }

        /* Responsive Tweaks */
        @media (max-width: 768px) {
            .hero-title { font-size: 1.5rem; }
            .controls-wrapper { flex-direction: column; gap: 15px; align-items: stretch !important; }
            .search-input-group { max-width: 100%; }
            .action-buttons { width: 100%; display: flex; justify-content: space-between; gap: 10px; overflow-x: auto; margin-left: 0 !important; margin-top: 10px; }
            .table-responsive { border: none; }
        }

        /* Progress Bar Custom */
        .progress-custom { height: 10px; background-color: rgba(255,255,255,0.5); border-radius: 10px; overflow: hidden; max-width: 600px; margin: 20px auto 0; }
        .progress-bar-custom { background-color: var(--accent-color); transition: width 0.3s ease; }
        
        /* Logs */
        .console-window { background-color: #1e1e1e; color: #4ade80; font-family: 'SF Mono', Consolas, monospace; font-size: 0.8rem; height: 150px; overflow-y: auto; border-radius: 8px; padding: 15px; margin-top: 20px; display: none; border: 1px solid #333; }
        /* FIX: Added Success and Warn colors */
        .log-error { color: #ef4444; } 
        .log-info { color: #94a3b8; }
        .log-success { color: #22c55e; }
        .log-warn { color: #facc15; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-envelope-paper-fill me-2"></i>Inbox Analyzer</a>
        <div class="d-flex align-items-center">
            <div class="dropdown">
                <div class="d-flex align-items-center cursor-pointer dropdown-toggle" data-bs-toggle="dropdown" style="cursor: pointer;">
                    <img id="user-avatar" src="https://via.placeholder.com/32" class="user-avatar me-2" alt="User">
                    <span id="user-name" class="fw-medium small d-none d-sm-block text-secondary">Loading...</span>
                </div>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2">
                    <li class="px-3 py-2 text-muted small" id="user-email">email@example.com</li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger small" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="hero-section">
    <div class="container-fluid" style="max-width: 1400px;">
        <div id="hero-status-content">
            <h1 class="hero-title" id="status-text">Scanning your inbox...</h1>
            <div id="scan-progress-wrapper">
                <div class="progress progress-custom mt-3">
                    <div id="progress-bar-inner" class="progress-bar progress-bar-custom" style="width: 0%"></div>
                </div>
                <div class="text-muted small mt-2" id="progress-detail">Initializing connection...</div>
            </div>
        </div>
    </div>
</div>

<div class="dashboard-container">
    <div class="container-fluid px-0" style="max-width: 1400px; margin: 0 auto;">
        
        <div class="content-card">
            <div class="controls-wrapper d-flex justify-content-between align-items-center">
                
                <div id="left-controls-area" class="d-flex align-items-center flex-grow-1 me-3">
                    <div id="search-container" class="search-input-group">
                        <i class="bi bi-search"></i>
                        <input type="text" id="searchInput" placeholder="Search senders..." onkeyup="handleSearch()">
                    </div>

                    <div id="bulk-actions-container" class="bulk-actions-group">
                        <span id="selection-count" class="text-primary fw-bold small me-2">0 Selected</span>
                        <button class="btn btn-bulk-delete" onclick="applyBulkRowAction('delete')">
                            <i class="bi bi-trash me-1"></i> Delete Selected
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-bulk-label dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-folder me-1"></i> Label Selected
                            </button>
                            <ul class="dropdown-menu shadow border-0" id="bulk-label-dropdown"></ul>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons d-flex align-items-center">
                    <button class="btn btn-light text-secondary border rounded-pill px-3 py-2 small me-2" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-light text-secondary border rounded-pill px-3 py-2 small me-2" onclick="downloadCSV()">
                        <i class="bi bi-download"></i> CSV
                    </button>
                    <button id="apply-btn" class="btn btn-primary rounded-pill px-4 py-2 small fw-bold" onclick="applyChanges()">
                        Apply Actions
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-custom mb-0 w-100">
                    <thead>
                        <tr>
                            <th style="width: 40px; padding-left: 24px;"><input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>Sender Email</th>
                            <th style="width: 120px;" class="text-center">Count</th>
                            <th style="width: 280px;" class="text-end pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody id="email-table-body">
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <div>Loading application data...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light" id="pagination-controls" style="display:none !important;">
                <div class="d-flex align-items-center text-muted small">
                    <span class="d-none d-sm-inline me-2">Rows:</span>
                    <select id="rowsPerPage" class="form-select form-select-sm" style="width: 70px;" onchange="changeRowsPerPage()">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                    </select>
                </div>
                
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary border-0 me-1" onclick="changePage(-1)"><i class="bi bi-chevron-left"></i></button>
                    <span class="mx-2 small text-muted" id="page-info">1-50 of 100</span>
                    <button class="btn btn-sm btn-outline-secondary border-0 ms-1" onclick="changePage(1)"><i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <button class="btn btn-link text-decoration-none btn-sm text-secondary opacity-75" onclick="toggleLogs()">
                <i class="bi bi-terminal me-1"></i> Show System Logs
            </button>
            <div id="scan-debugger" class="console-window text-start mx-auto" style="max-width: 800px;">
                <div class="log-info">System ready.</div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="labelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Create New Label</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-4">
                <div class="mb-3">
                    <label class="form-label small text-muted text-uppercase fw-bold">Label Name</label>
                    <input type="text" class="form-control form-control-lg bg-light border-0" id="newLabelName" placeholder="e.g. Newsletters">
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="nestLabelCheck" onchange="toggleNestDropdown()">
                    <label class="form-check-label small">Nest under parent label</label>
                </div>
                <select class="form-select" id="parentLabelSelect" disabled></select>
            </div>
            <div class="modal-footer border-top-0 pt-0 pb-4">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" onclick="confirmLabelCreation()">Create Label</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allData = [];
    let filteredData = [];
    let existingLabels = [];
    let currentPage = 1;
    let rowsPerPage = 50;
    let pendingActions = {};
    let labelOptionsHTML = "";
    let currentEditingRowEmail = null;

    window.onload = async function() {
        fetchUserInfo();
        try {
            const labelRes = await fetch('/api/get_labels');
            existingLabels = await labelRes.json();
            labelOptionsHTML = existingLabels.filter(l => l.type === 'user').map(l => `<option value="label:${l.id}">${l.name}</option>`).join('');
            populateParentLabelSelect();
            populateBulkDropdown(); 
        } catch(e) { console.log("Label fetch error", e); }
        startScanStream();
    };

    async function fetchUserInfo() {
        try {
            const res = await fetch('/api/user_info');
            const data = await res.json();
            if (data.name) document.getElementById('user-name').innerText = data.name;
            if (data.picture) document.getElementById('user-avatar').src = data.picture;
            if (data.email) document.getElementById('user-email').innerText = data.email;
            
            // --- LOG SESSION TYPE ---
            if (data.session_storage) {
                const type = data.session_storage;
                const msg = type === 'redis' 
                    ? "Session storage: Redis (Persistent)" 
                    : "Session storage: Filesystem (Ephemeral - resets on restart)";
                logToScanDebugger(msg, type === 'redis' ? 'success' : 'warn');
            }
        } catch(e) { console.error("User info fetch failed", e); }
    }

    function renderTable() {
        const tbody = document.getElementById('email-table-body');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredData.slice(start, end);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">No emails found matching your search.</td></tr>';
            document.getElementById('pagination-controls').style.setProperty('display', 'none', 'important');
            return;
        }

        pageData.forEach(row => {
            const tr = document.createElement('tr');
            
            let selectedValue = 'none';
            let rowClass = '';
            let isDisabled = false;

            if (row.processedAction) {
                selectedValue = row.processedAction;
                rowClass = 'row-processed';
                isDisabled = true;
            } else if (pendingActions[row.email]) {
                const pending = pendingActions[row.email];
                if (pending.action === 'delete') selectedValue = 'delete';
                else if (pending.action === 'label') selectedValue = `label:${pending.labelId}`;
            }

            if(rowClass) tr.className = rowClass;

            tr.innerHTML = `
                <td style="padding-left: 24px;">
                    <input type="checkbox" class="form-check-input row-checkbox" onchange="updateSelection()" ${isDisabled ? 'disabled' : ''}>
                </td>
                <td class="email-text"></td> 
                <td class="text-center"><span class="count-badge">${row.count}</span></td>
                <td class="text-end pe-4">
                    <select class="form-select form-select-sm action-select d-inline-block" style="width: auto; max-width: 200px;" data-email="${row.email}" onchange="handleActionChange(this)">
                        <option value="none">Choose action...</option>
                        <option value="delete" class="text-danger">Delete</option>
                        <optgroup label="Send to Folder">
                            <option value="new_label">+ Create New Label</option>
                            ${labelOptionsHTML}
                        </optgroup>
                    </select>
                </td>
            `;
            
            tr.querySelector('.email-text').textContent = row.email;
            
            const select = tr.querySelector('select');
            select.value = selectedValue;
            tbody.appendChild(tr);
        });

        document.getElementById('page-info').innerText = `${start + 1}-${Math.min(end, filteredData.length)} of ${filteredData.length}`;
        document.getElementById('pagination-controls').style.setProperty('display', 'flex', 'important');
        updateSelection();
    }

    function changeRowsPerPage() {
        rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
        currentPage = 1;
        renderTable();
    }
    function changePage(delta) {
        const maxPage = Math.ceil(filteredData.length / rowsPerPage);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= maxPage) { currentPage = newPage; renderTable(); }
    }
    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        filteredData = allData.filter(row => row.email.includes(term));
        currentPage = 1;
        renderTable();
    }

    function toggleSelectAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.row-checkbox:not(:disabled)').forEach(cb => cb.checked = checked);
        updateSelection();
    }

    function updateSelection() {
        const count = document.querySelectorAll('.row-checkbox:checked').length;
        const bulkContainer = document.getElementById('bulk-actions-container');
        const searchContainer = document.getElementById('search-container');
        const indicator = document.getElementById('selection-count');
        
        if (count > 0) {
            searchContainer.style.display = 'none';
            bulkContainer.style.display = 'flex';
            indicator.innerText = `${count} Selected`;
        } else {
            bulkContainer.style.display = 'none';
            searchContainer.style.display = 'block';
        }
    }

    function populateBulkDropdown() {
        const ul = document.getElementById('bulk-label-dropdown');
        ul.innerHTML = existingLabels.filter(l => l.type === 'user').map(l => 
            `<li><a class="dropdown-item" href="#" onclick="applyBulkRowAction('label:${l.id}')">${l.name}</a></li>`
        ).join('');
    }

    function applyBulkRowAction(actionValue) {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        checkboxes.forEach(cb => {
            const tr = cb.closest('tr');
            const select = tr.querySelector('.action-select');
            select.value = actionValue;
            handleActionChange(select);
        });
    }

    function downloadCSV() {
        let csvContent = "data:text/csv;charset=utf-8,Sender Email,Count\n";
        filteredData.forEach(row => { csvContent += `${row.email},${row.count}\n`; });
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "inbox_analysis.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function toggleLogs() {
        const logWin = document.getElementById('scan-debugger');
        logWin.style.display = (logWin.style.display === 'none' || logWin.style.display === '') ? 'block' : 'none';
    }

    function logToScanDebugger(msg, type='info') {
        const consoleWin = document.getElementById('scan-debugger');
        const line = document.createElement('div');
        line.className = `log-${type}`;
        line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        consoleWin.appendChild(line);
        while (consoleWin.children.length > 50) {
            consoleWin.removeChild(consoleWin.firstChild);
        }
        consoleWin.scrollTop = consoleWin.scrollHeight;
    }

    let scanEventSource = null;

    function startScanStream() {
        if (scanEventSource) scanEventSource.close();

        scanEventSource = new EventSource("/api/scan_stream");
        const progressBar = document.getElementById('progress-bar-inner');
        const progressDetail = document.getElementById('progress-detail');
        const statusText = document.getElementById('status-text');
        
        scanEventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.log) logToScanDebugger(data.log, data.level || 'info');
            if (data.error) { logToScanDebugger("ERROR: " + data.error, "error"); scanEventSource.close(); }
            
            if (data.status === 'init') {
                statusText.innerText = "Connecting to Gmail...";
                progressDetail.innerText = data.message;
            } else if (data.status === 'progress') {
                progressBar.style.width = data.percent + "%";
                statusText.innerText = `Scanning Inbox (${data.percent}%)`;
                progressDetail.innerText = `Processed ${data.processed} of ${data.total} emails...`;
            } else if (data.status === 'complete') {
                allData = data.data;
                const totalEmails = allData.reduce((sum, item) => sum + item.count, 0);
                const heroContent = document.getElementById('hero-status-content');
                heroContent.innerHTML = `<h1 class="hero-title" style="margin-top: 10px;">You have <span class="hero-count">${totalEmails} emails</span> in your inbox.</h1>`;
                filteredData = allData;
                renderTable();
                scanEventSource.close();
            }
        };
        scanEventSource.onerror = function() { scanEventSource.close(); };
    }

    window.addEventListener('beforeunload', function() {
        if (scanEventSource) scanEventSource.close();
    });

    function handleActionChange(selectElem) {
        const val = selectElem.value;
        const email = selectElem.dataset.email;
        if (val === 'new_label') {
            currentEditingRowEmail = email;
            new bootstrap.Modal(document.getElementById('labelModal')).show();
        } else if (val.startsWith('label:')) {
            const labelId = val.split(':')[1];
            const labelName = selectElem.options[selectElem.selectedIndex].text;
            pendingActions[email] = { action: 'label', labelId: labelId, labelName: labelName };
        } else if (val === 'delete') {
            pendingActions[email] = { action: 'delete' };
        } else { 
            delete pendingActions[email]; 
        }
    }
    
    function toggleNestDropdown() { document.getElementById('parentLabelSelect').disabled = !document.getElementById('nestLabelCheck').checked; }
    function populateParentLabelSelect() {
        const select = document.getElementById('parentLabelSelect');
        existingLabels.forEach(l => { if(l.type === 'user') {
            const opt = document.createElement('option');
            opt.value = l.id; opt.text = l.name;
            select.appendChild(opt);
        }});
    }
    function confirmLabelCreation() {
        const name = document.getElementById('newLabelName').value;
        const isNested = document.getElementById('nestLabelCheck').checked;
        const parentId = document.getElementById('parentLabelSelect').value;
        const parentName = document.getElementById('parentLabelSelect').options[document.getElementById('parentLabelSelect').selectedIndex]?.text;
        
        pendingActions[currentEditingRowEmail] = {
            action: 'label', isNew: true, labelName: name,
            parentId: isNested ? parentId : null, parentName: isNested ? parentName : null
        };
        const select = document.querySelector(`.action-select[data-email="${currentEditingRowEmail}"]`);
        const opt = document.createElement('option');
        opt.value = "temp_custom"; opt.text = `New Label: ${name}`; opt.selected = true;
        select.add(opt, select[1]);
        bootstrap.Modal.getInstance(document.getElementById('labelModal')).hide();
    }

    async function applyChanges() {
        const btn = document.getElementById('apply-btn');
        if (btn.disabled) return;

        const selects = document.querySelectorAll('.action-select');
        const actions = [];
        for (const [email, actionData] of Object.entries(pendingActions)) {
            actions.push({ email: email, ...actionData });
        }

        if(actions.length === 0) return alert("No actions selected");

        btn.disabled = true;
        btn.innerText = "Processing...";
        toggleLogs(); 
        logToScanDebugger("Starting Apply Changes...", "info");

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        try {
            const response = await fetch('/api/apply_actions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }, 
                body: JSON.stringify(actions)
            });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value).split('\n');
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const jsonLog = JSON.parse(line);
                        if (jsonLog.status === 'complete') {
                            logToScanDebugger("Actions complete.", "success");
                            actions.forEach(act => {
                                const item = allData.find(d => d.email === act.email);
                                if(item) {
                                    item.processedAction = (act.action === 'delete') ? 'delete' : `label:${act.labelId}`;
                                    delete pendingActions[act.email];
                                }
                            });
                            renderTable();
                            btn.disabled = false;
                            btn.innerText = "Apply Actions";
                        } else if (jsonLog.msg) {
                            logToScanDebugger(jsonLog.msg, jsonLog.msg.includes("ERROR") ? 'error' : 'info');
                        }
                    } catch(e) {}
                }
            }
        } catch (err) {
            logToScanDebugger(`Connection Error: ${err.message}`, "error");
            btn.disabled = false;
            btn.innerText = "Apply Actions";
        }
    }
</script>
</body>
</html>