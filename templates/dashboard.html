<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Cleaner Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-container { margin-bottom: 2rem; padding: 1.5rem; border: 1px solid #dee2e6; border-radius: 0.5rem; }
        .log-box { height: 150px; overflow-y: scroll; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; font-family: monospace; font-size: 0.9rem; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Gmail Cleaner</h1>
        <div>
            <span id="user-email" class="me-3 text-muted">Loading...</span>
            <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
        </div>
    </div>

    <div class="step-container bg-white shadow-sm">
        <h3>Step 1: Scan Inbox</h3>
        <p class="text-muted">This will scan your inbox to find frequent senders.</p>
        
        <div class="progress mb-3 hidden" id="scan-progress-container">
            <div id="scan-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
        
        <div id="scan-log" class="log-box mb-3">Ready to scan...</div>
        
        <button id="btn-scan" class="btn btn-primary">Start Scan</button>
    </div>

    <div id="action-section" class="step-container bg-white shadow-sm hidden">
        <h3>Step 2: Review & Take Action</h3>
        <p class="text-muted">Select actions for the top senders found.</p>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%">Sender Email</th>
                        <th style="width: 15%">Count</th>
                        <th style="width: 45%">Action</th>
                    </tr>
                </thead>
                <tbody id="results-body"></tbody>
            </table>
        </div>

        <div class="mt-4">
            <button id="btn-apply" class="btn btn-success btn-lg w-100">Apply Selected Actions</button>
        </div>
        
        <div id="apply-log" class="log-box mt-3 hidden"></div>
    </div>
</div>

<script>
let existingLabels = [];

// 1. Load User Info & Labels on Start
async function init() {
    // Get User Email
    try {
        const uRes = await fetch('/api/user_info');
        const user = await uRes.json();
        if (user.email) document.getElementById('user-email').innerText = user.email;
    } catch (e) { console.error(e); }

    // Get Labels (The critical part for your rollback)
    try {
        const lRes = await fetch('/api/get_labels');
        existingLabels = await lRes.json();
        console.log("Labels loaded:", existingLabels.length);
    } catch (e) { console.error("Error loading labels", e); }
}
init();

// 2. Scan Logic (SSE)
const btnScan = document.getElementById('btn-scan');
const scanLog = document.getElementById('scan-log');
const scanBar = document.getElementById('scan-bar');
const progressContainer = document.getElementById('scan-progress-container');
const actionSection = document.getElementById('action-section');
const resultsBody = document.getElementById('results-body');

btnScan.addEventListener('click', () => {
    btnScan.disabled = true;
    scanLog.innerHTML = '';
    progressContainer.classList.remove('hidden');
    
    const eventSource = new EventSource('/api/scan_stream');
    
    eventSource.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.log) {
            const entry = document.createElement('div');
            entry.innerText = data.log;
            if (data.level === 'error') entry.style.color = 'red';
            if (data.level === 'success') entry.style.color = 'green';
            scanLog.appendChild(entry);
            scanLog.scrollTop = scanLog.scrollHeight;
        }

        if (data.status === 'progress') {
            scanBar.style.width = data.percent + '%';
            scanBar.innerText = data.percent + '%';
        }

        if (data.status === 'complete') {
            eventSource.close();
            btnScan.disabled = false;
            renderTable(data.data || []);
            actionSection.classList.remove('hidden');
        }
    };

    eventSource.onerror = function() {
        eventSource.close();
        btnScan.disabled = false;
        scanLog.innerHTML += '<div style="color:red">Connection lost.</div>';
    };
});

// 3. Render Table with Dropdowns
function renderTable(senders) {
    resultsBody.innerHTML = '';
    senders.slice(0, 50).forEach((item, index) => {
        const row = document.createElement('tr');
        
        // Build the Label Options
        // IMPORTANT: We map value=label.id, text=label.name
        let labelOptions = `<option value="" selected>Select existing label...</option>`;
        existingLabels.forEach(l => {
            labelOptions += `<option value="${l.id}">${l.name}</option>`;
        });

        row.innerHTML = `
            <td>${item.email}</td>
            <td><strong>${item.count}</strong></td>
            <td>
                <select class="form-select action-select mb-2" onchange="toggleInputs(this, ${index})">
                    <option value="ignore" selected>Ignore</option>
                    <option value="delete">Delete All (Trash)</option>
                    <option value="label">Move to Label</option>
                </select>

                <div id="label-inputs-${index}" class="hidden p-2 bg-light border rounded">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="labelType-${index}" id="exist-${index}" value="existing" checked onchange="toggleLabelMode(${index}, 'existing')">
                        <label class="form-check-label" for="exist-${index}">Existing Label</label>
                    </div>
                    <select class="form-select mb-2" id="dropdown-${index}">
                        ${labelOptions}
                    </select>

                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="labelType-${index}" id="new-${index}" value="new" onchange="toggleLabelMode(${index}, 'new')">
                        <label class="form-check-label" for="new-${index}">New Label</label>
                    </div>
                    <input type="text" class="form-control form-control-sm hidden" id="newinput-${index}" placeholder="Enter new label name">
                </div>
            </td>
        `;
        resultsBody.appendChild(row);
    });
}

// UI Toggles
window.toggleInputs = function(selectElem, idx) {
    const div = document.getElementById(`label-inputs-${idx}`);
    if (selectElem.value === 'label') div.classList.remove('hidden');
    else div.classList.add('hidden');
};

window.toggleLabelMode = function(idx, mode) {
    const dd = document.getElementById(`dropdown-${idx}`);
    const inp = document.getElementById(`newinput-${idx}`);
    if (mode === 'existing') {
        dd.classList.remove('hidden');
        inp.classList.add('hidden');
    } else {
        dd.classList.add('hidden');
        inp.classList.remove('hidden');
    }
};

// 4. Apply Actions
document.getElementById('btn-apply').addEventListener('click', async () => {
    const actions = [];
    const rows = resultsBody.querySelectorAll('tr');
    
    rows.forEach((row, index) => {
        const email = row.cells[0].innerText;
        const action = row.querySelector('.action-select').value;
        
        if (action === 'ignore') return;

        let payload = { email, action };

        if (action === 'label') {
            const mode = document.querySelector(`input[name="labelType-${index}"]:checked`).value;
            if (mode === 'existing') {
                const select = document.getElementById(`dropdown-${index}`);
                payload.labelId = select.value; // ID from backend
                payload.labelName = select.options[select.selectedIndex].text; // Name for display
                payload.isNew = false;
            } else {
                payload.labelName = document.getElementById(`newinput-${index}`).value;
                payload.isNew = true;
            }
            // Validation
            if (!payload.labelId && !payload.isNew) return; // Skip if no label selected
            if (payload.isNew && !payload.labelName) return; // Skip if no name typed
        }
        actions.push(payload);
    });

    if (actions.length === 0) return alert("No actions selected.");

    const logDiv = document.getElementById('apply-log');
    logDiv.classList.remove('hidden');
    logDiv.innerText = "Initiating actions...\n";

    // Streaming Response for Actions
    try {
        const response = await fetch('/api/apply_actions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(actions)
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            lines.forEach(line => {
                if (!line.trim()) return;
                try {
                    const data = JSON.parse(line);
                    if (data.msg) {
                        logDiv.innerText += data.msg + "\n";
                        logDiv.scrollTop = logDiv.scrollHeight;
                    }
                    if (data.status === 'complete') {
                        alert("All actions completed!");
                        window.location.reload();
                    }
                } catch(e) {}
            });
        }
    } catch (e) {
        logDiv.innerText += "Error applying actions.\n";
    }
});
</script>
</body>
</html>