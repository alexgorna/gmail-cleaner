<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inbox Cleaner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .scrollable-table { max-height: 500px; overflow-y: auto; }
        .sticky-header th { position: sticky; top: 0; background-color: white; z-index: 1; }
        
        /* Debugger Window Styles */
        .console-window {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            height: 200px;
            overflow-y: auto;
            border-radius: 5px;
            padding: 10px;
            border: 1px solid #444;
        }
        .log-info { color: #cccccc; }
        .log-success { color: #28a745; }
        .log-warn { color: #ffc107; }
        .log-error { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body class="bg-light p-5">

<div class="container bg-white p-4 rounded shadow mb-4">
    <h2>Inbox Analyzer</h2>
    
    <div id="progress-container" class="my-3">
        <div class="d-flex justify-content-between mb-1">
            <span id="progress-text">Connecting to Inbox...</span>
            <span id="progress-percent">0%</span>
        </div>
        <div class="progress" style="height: 25px;">
            <div id="progress-bar-inner" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 1%"></div>
        </div>
    </div>

    <div id="error-alert" class="alert alert-danger" style="display:none;" role="alert"></div>

    <div class="scrollable-table border rounded mt-3">
        <table class="table table-hover mb-0">
            <thead class="sticky-header">
                <tr>
                    <th>Sender Email</th>
                    <th>Count</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="email-table-body"></tbody>
        </table>
        <div id="load-more-container" class="p-2 text-center" style="display:none;">
            <button class="btn btn-outline-secondary btn-sm" onclick="loadMoreRows()">Load More rows...</button>
        </div>
    </div>

    <div class="mt-4 d-grid gap-2">
        <button id="apply-btn" class="btn btn-primary btn-lg" onclick="applyChanges()">APPLY CHANGES</button>
    </div>
</div>

<div class="container bg-white p-3 rounded shadow">
    <h5>System Logs & Debugger</h5>
    <div id="scan-debugger" class="console-window">
        <div class="log-info">Waiting for start...</div>
    </div>
</div>

<div class="modal fade" id="labelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Label</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name:</label>
                    <input type="text" class="form-control" id="newLabelName">
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="nestLabelCheck" onchange="toggleNestDropdown()">
                    <label class="form-check-label">Nest label under:</label>
                </div>
                <select class="form-select" id="parentLabelSelect" disabled></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmLabelCreation()">Create</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let scannedData = [];
    let existingLabels = [];
    let currentEditingRowEmail = null;
    let pendingActions = {};
    let currentRenderIndex = 0;
    const PAGE_SIZE = 50;
    let labelOptionsHTML = "";

    function logToScanDebugger(msg, type='info') {
        const consoleWin = document.getElementById('scan-debugger');
        const line = document.createElement('div');
        line.className = `log-${type}`;
        
        // Add timestamp
        const time = new Date().toLocaleTimeString();
        line.innerText = `[${time}] ${msg}`;
        
        consoleWin.appendChild(line);
        consoleWin.scrollTop = consoleWin.scrollHeight;
    }

    window.onload = async function() {
        const labelRes = await fetch('/api/get_labels');
        existingLabels = await labelRes.json();
        labelOptionsHTML = existingLabels
            .filter(l => l.type === 'user')
            .map(l => `<option value="label:${l.id}">${l.name}</option>`)
            .join('');
        populateParentLabelSelect();
        startScanStream();
    };

    function startScanStream() {
        const evtSource = new EventSource("/api/scan_stream");
        const progressBar = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');
        const progressPercent = document.getElementById('progress-percent');
        
        // Clear previous logs
        document.getElementById('scan-debugger').innerHTML = '';
        logToScanDebugger("Initializing connection...", "info");

        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.log) {
                logToScanDebugger(data.log, data.level || 'info');
                // We don't return here because 'log' messages might also have 'progress' data attached
            }

            if (data.error) {
                showError(data.error);
                logToScanDebugger("CRITICAL ERROR: " + data.error, "error");
                evtSource.close();
                return;
            }

            if (data.status === 'init') {
                progressText.innerText = data.message;
            } else if (data.status === 'counting') {
                progressText.innerText = `Found ${data.count} emails...`;
            } else if (data.status === 'progress') {
                const pct = data.percent + "%";
                progressBar.style.width = pct;
                progressPercent.innerText = pct;
                progressText.innerText = `Scanning ${data.processed} of ${data.total} emails...`;
            } else if (data.status === 'complete') {
                progressBar.style.width = "100%";
                progressText.innerText = "Scan Complete!";
                logToScanDebugger("Scan finished successfully.", "success");
                
                scannedData = data.data;
                currentRenderIndex = 0;
                document.getElementById('email-table-body').innerHTML = '';
                loadMoreRows(); 
                evtSource.close();
                // REMOVED: The line that hid the progress bar. Now it stays visible.
            }
        };
        
        evtSource.onerror = function() { 
            logToScanDebugger("EventSource connection lost.", "error");
            evtSource.close(); 
        };
    }

    function loadMoreRows() {
        const tbody = document.getElementById('email-table-body');
        const nextBatch = scannedData.slice(currentRenderIndex, currentRenderIndex + PAGE_SIZE);
        const fragment = document.createDocumentFragment();
        nextBatch.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.email}</td>
                <td>${row.count}</td>
                <td>
                    <select class="form-select action-select" data-email="${row.email}" onchange="handleActionChange(this)">
                        <option value="none" selected>Choose action...</option>
                        <option value="delete">Delete</option>
                        <optgroup label="Send to Folder">
                            <option value="new_label">+ Create New Label</option>
                            ${labelOptionsHTML}
                        </optgroup>
                    </select>
                </td>`;
            fragment.appendChild(tr);
        });
        tbody.appendChild(fragment);
        currentRenderIndex += PAGE_SIZE;
        const btnContainer = document.getElementById('load-more-container');
        btnContainer.style.display = (currentRenderIndex < scannedData.length) ? 'block' : 'none';
    }

    function showError(msg) {
        const alertBox = document.getElementById('error-alert');
        alertBox.innerText = msg;
        alertBox.style.display = 'block';
    }

    function handleActionChange(selectElem) {
        const val = selectElem.value;
        const email = selectElem.dataset.email;
        if (val === 'new_label') {
            currentEditingRowEmail = email;
            new bootstrap.Modal(document.getElementById('labelModal')).show();
        } else { delete pendingActions[email]; }
    }
    function toggleNestDropdown() { document.getElementById('parentLabelSelect').disabled = !document.getElementById('nestLabelCheck').checked; }
    function populateParentLabelSelect() {
        const select = document.getElementById('parentLabelSelect');
        existingLabels.forEach(l => { if(l.type === 'user') {
            const opt = document.createElement('option');
            opt.value = l.id; opt.text = l.name;
            select.appendChild(opt);
        }});
    }
    function confirmLabelCreation() {
        const name = document.getElementById('newLabelName').value;
        const isNested = document.getElementById('nestLabelCheck').checked;
        const parentId = document.getElementById('parentLabelSelect').value;
        const parentName = document.getElementById('parentLabelSelect').options[document.getElementById('parentLabelSelect').selectedIndex]?.text;
        pendingActions[currentEditingRowEmail] = {
            action: 'label', isNew: true, labelName: name,
            parentId: isNested ? parentId : null, parentName: isNested ? parentName : null
        };
        const select = document.querySelector(`.action-select[data-email="${currentEditingRowEmail}"]`);
        const opt = document.createElement('option');
        opt.value = "temp_custom"; opt.text = `New Label: ${name}`; opt.selected = true;
        select.add(opt, select[1]);
        bootstrap.Modal.getInstance(document.getElementById('labelModal')).hide();
    }

    async function applyChanges() {
        const selects = document.querySelectorAll('.action-select');
        const actions = [];
        selects.forEach(s => {
            if (s.value === 'none') return;
            const email = s.dataset.email;
            if (pendingActions[email] && s.value === 'temp_custom') actions.push({ email: email, ...pendingActions[email] });
            else if (s.value === 'delete') actions.push({ email: email, action: 'delete' });
            else if (s.value.startsWith('label:')) {
                const labelName = s.options[s.selectedIndex].text;
                actions.push({ email: email, action: 'label', labelId: s.value.split(':')[1], labelName: labelName });
            }
        });
        if(actions.length === 0) return alert("No actions selected");

        document.getElementById('apply-btn').disabled = true;
        document.getElementById('apply-btn').innerText = "Processing...";
        // We reuse the bottom console for this too, or you can keep the separate one. 
        // For simplicity, I'll log to the same bottom window so everything is in one place.
        logToScanDebugger("Starting Apply Changes...", "info");

        try {
            const response = await fetch('/api/apply_actions', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(actions)
            });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value).split('\n');
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const jsonLog = JSON.parse(line);
                        if (jsonLog.status === 'complete') {
                            logToScanDebugger("All actions complete. Reloading...", "success");
                            setTimeout(() => window.location.reload(), 2000);
                        } else if (jsonLog.msg) {
                            let type = 'info';
                            if(jsonLog.msg.includes("ERROR")) type = 'error';
                            if(jsonLog.msg.includes("Warning")) type = 'warn';
                            if(jsonLog.msg.includes("SUCCESS")) type = 'success';
                            logToScanDebugger(jsonLog.msg, type);
                        }
                    } catch(e) {}
                }
            }
        } catch (err) {
            logToScanDebugger(`Connection Error: ${err.message}`, "error");
            document.getElementById('apply-btn').disabled = false;
        }
    }
</script>
</body>
</html>