<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inbox Cleaner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .scrollable-table { max-height: 600px; overflow-y: auto; }
        .sticky-header th { position: sticky; top: 0; background-color: white; z-index: 1; }
    </style>
</head>
<body class="bg-light p-5">

<div class="container bg-white p-4 rounded shadow">
    <h2>Inbox Analyzer</h2>
    
    <div id="progress-container" class="my-3">
        <div class="d-flex justify-content-between mb-1">
            <span id="progress-text">Connecting to Inbox...</span>
            <span id="progress-percent">0%</span>
        </div>
        <div class="progress" style="height: 25px;">
            <div id="progress-bar-inner" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 1%"></div>
        </div>
    </div>

    <div id="error-alert" class="alert alert-danger" style="display:none;" role="alert"></div>

    <div class="scrollable-table border rounded mt-3">
        <table class="table table-hover mb-0">
            <thead class="sticky-header">
                <tr>
                    <th>Sender Email</th>
                    <th>Count</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="email-table-body"></tbody>
        </table>
    </div>

    <div class="mt-4 d-grid gap-2">
        <button class="btn btn-primary btn-lg" onclick="applyChanges()">APPLY CHANGES</button>
    </div>
</div>

<div class="modal fade" id="labelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Label</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name:</label>
                    <input type="text" class="form-control" id="newLabelName">
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="nestLabelCheck" onchange="toggleNestDropdown()">
                    <label class="form-check-label">Nest label under:</label>
                </div>
                <select class="form-select" id="parentLabelSelect" disabled></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmLabelCreation()">Create</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let scannedData = [];
    let existingLabels = [];
    let currentEditingRowEmail = null;
    let pendingActions = {};

    window.onload = async function() {
        // 1. Fetch Labels
        const labelRes = await fetch('/api/get_labels');
        existingLabels = await labelRes.json();
        populateParentLabelSelect();

        // 2. Start Streaming Scan
        startScanStream();
    };

    function startScanStream() {
        const evtSource = new EventSource("/api/scan_stream");
        const progressBar = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');
        const progressPercent = document.getElementById('progress-percent');

        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.error) {
                showError(data.error);
                evtSource.close();
                return;
            }

            if (data.status === 'init') {
                progressText.innerText = data.message;
            } else if (data.status === 'counting') {
                progressText.innerText = `Found ${data.count} emails...`;
            } else if (data.status === 'progress') {
                const pct = data.percent + "%";
                progressBar.style.width = pct;
                progressPercent.innerText = pct;
                progressText.innerText = `Scanning ${data.processed} of ${data.total} emails...`;
            } else if (data.status === 'complete') {
                progressBar.style.width = "100%";
                progressText.innerText = "Scan Complete!";
                setTimeout(() => document.getElementById('progress-container').style.display = 'none', 1000);
                
                scannedData = data.data;
                renderTable();
                evtSource.close();
            }
        };

        evtSource.onerror = function() {
            evtSource.close();
        };
    }

    function showError(msg) {
        const alertBox = document.getElementById('error-alert');
        alertBox.innerText = msg;
        alertBox.style.display = 'block';
        document.getElementById('progress-container').style.display = 'none';
    }

    function renderTable() {
        const tbody = document.getElementById('email-table-body');
        tbody.innerHTML = '';
        scannedData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.email}</td>
                <td>${row.count}</td>
                <td>
                    <select class="form-select action-select" data-email="${row.email}" onchange="handleActionChange(this)">
                        <option value="none" selected>Choose action...</option>
                        <option value="delete">Delete</option>
                        <optgroup label="Send to Folder">
                            <option value="new_label">+ Create New Label</option>
                            ${existingLabels.filter(l => l.type === 'user').map(l => `<option value="label:${l.id}">${l.name}</option>`).join('')}
                        </optgroup>
                    </select>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function handleActionChange(selectElem) {
        const val = selectElem.value;
        const email = selectElem.dataset.email;
        if (val === 'new_label') {
            currentEditingRowEmail = email;
            new bootstrap.Modal(document.getElementById('labelModal')).show();
        } else {
            delete pendingActions[email];
        }
    }
    function toggleNestDropdown() {
        document.getElementById('parentLabelSelect').disabled = !document.getElementById('nestLabelCheck').checked;
    }
    function populateParentLabelSelect() {
        const select = document.getElementById('parentLabelSelect');
        existingLabels.forEach(l => {
            if(l.type === 'user') {
                const opt = document.createElement('option');
                opt.value = l.id; 
                opt.text = l.name;
                select.appendChild(opt);
            }
        });
    }
    function confirmLabelCreation() {
        const name = document.getElementById('newLabelName').value;
        const isNested = document.getElementById('nestLabelCheck').checked;
        const parentId = document.getElementById('parentLabelSelect').value;
        const parentName = document.getElementById('parentLabelSelect').options[document.getElementById('parentLabelSelect').selectedIndex]?.text;
        
        pendingActions[currentEditingRowEmail] = {
            action: 'label', isNew: true, labelName: name,
            parentId: isNested ? parentId : null, parentName: isNested ? parentName : null
        };
        const select = document.querySelector(`.action-select[data-email="${currentEditingRowEmail}"]`);
        const opt = document.createElement('option');
        opt.value = "temp_custom"; opt.text = `New Label: ${name}`; opt.selected = true;
        select.add(opt, select[1]);
        bootstrap.Modal.getInstance(document.getElementById('labelModal')).hide();
    }
    async function applyChanges() {
        const selects = document.querySelectorAll('.action-select');
        const actions = [];
        selects.forEach(s => {
            if (s.value === 'none') return;
            const email = s.dataset.email;
            if (pendingActions[email] && s.value === 'temp_custom') actions.push({ email: email, ...pendingActions[email] });
            else if (s.value === 'delete') actions.push({ email: email, action: 'delete' });
            else if (s.value.startsWith('label:')) actions.push({ email: email, action: 'label', labelId: s.value.split(':')[1] });
        });
        if(actions.length === 0) return alert("No actions selected");
        
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('progress-text').innerText = "Applying changes...";
        
        await fetch('/api/apply_actions', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(actions)
        });
        alert("Done!");
        window.location.reload();
    }
</script>
</body>
</html>