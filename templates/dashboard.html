<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox Analyzer</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary-bg: #f0f4f8; --accent-color: #0d6efd; }
        body { background-color: var(--primary-bg); font-family: sans-serif; color: #333; }
        .navbar { background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .hero-section { background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 60px 20px 80px 20px; text-align: center; }
        .hero-title { font-size: 2rem; font-weight: 300; margin: 0; }
        .hero-count { font-weight: 700; color: var(--accent-color); }
        .dashboard-container { margin-top: -50px; padding: 0 20px; margin-bottom: 50px; }
        .content-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .controls-wrapper { padding: 20px; background: #fff; min-height: 85px; display: flex; justify-content: space-between; align-items: center; }
        
        .search-input-group { max-width: 500px; width: 100%; position: relative; }
        .search-input-group input { padding-left: 40px; border-radius: 50px; background: #f8fafc; border: 1px solid #e2e8f0; height: 45px; }
        
        .bulk-actions-group { display: none; align-items: center; gap: 10px; }
        .dropdown-menu { max-height: 300px; overflow-y: auto; } /* FIX: Scrollable Dropdown */
        
        .table-custom th { background: #f8fafc; color: #64748b; font-weight: 600; padding: 16px; border-bottom: 1px solid #e2e8f0; }
        .table-custom td { padding: 16px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        .count-badge { background: #dbeafe; color: #1e40af; padding: 6px 12px; border-radius: 20px; font-weight: 600; }
        .action-select { border-radius: 20px; padding: 6px 30px 6px 12px; cursor: pointer; }
        
        .row-processed { opacity: 0.5; background: #f8f9fa; pointer-events: none; }
        .console-window { background: #1e1e1e; color: #4ade80; height: 150px; overflow-y: auto; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 0.8rem; margin-top: 20px; display: none; }
        .log-error { color: #ef4444; } .log-success { color: #22c55e; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold text-primary" href="#">Inbox Analyzer</a>
        <div class="dropdown">
            <div class="d-flex align-items-center cursor-pointer dropdown-toggle" data-bs-toggle="dropdown">
                <img id="user-avatar" src="https://via.placeholder.com/32" class="user-avatar me-2">
                <span id="user-name" class="fw-medium small">Loading...</span>
            </div>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2">
                <li class="px-3 py-2 small" id="user-email">email@example.com</li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger small" href="/logout">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="hero-section">
    <div id="hero-status-content">
        <h1 class="hero-title" id="status-text">Scanning...</h1>
        <div class="progress progress-custom mt-3" style="max-width: 600px; margin: 0 auto;">
            <div id="progress-bar-inner" class="progress-bar progress-bar-custom" style="width: 0%"></div>
        </div>
    </div>
</div>

<div class="dashboard-container">
    <div class="content-card">
        <div class="controls-wrapper">
            <div class="d-flex align-items-center gap-3 w-100">
                <div id="search-container" class="search-input-group">
                    <input type="text" id="searchInput" placeholder="Search senders..." onkeyup="handleSearch()">
                </div>
                <div id="bulk-actions-container" class="bulk-actions-group">
                    <span id="selection-count" class="fw-bold text-primary small">0 Selected</span>
                    <button class="btn btn-outline-danger rounded-pill btn-sm" onclick="applyBulkRowAction('delete')">Delete Selected</button>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle rounded-pill btn-sm" type="button" data-bs-toggle="dropdown">Label Selected</button>
                        <ul class="dropdown-menu shadow border-0" id="bulk-label-dropdown"></ul>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light rounded-circle" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i></button>
                <button id="apply-btn" class="btn btn-primary rounded-pill px-4 fw-bold" onclick="applyChanges()">Apply Actions</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-custom mb-0">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>Sender Email</th>
                        <th class="text-center">Count</th>
                        <th class="text-end pe-4">Action</th>
                    </tr>
                </thead>
                <tbody id="email-table-body">
                    <tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="text-center mt-3">
        <button class="btn btn-link btn-sm text-secondary" onclick="toggleLogs()">Show Logs</button>
        <div id="scan-debugger" class="console-window text-start mx-auto" style="max-width: 800px;"></div>
    </div>
</div>

<div class="modal fade" id="labelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0"><h5 class="fw-bold">Create New Label</h5></div>
            <div class="modal-body">
                <input type="text" class="form-control bg-light border-0 mb-2" id="newLabelName" placeholder="Label Name">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="nestLabelCheck" onchange="document.getElementById('parentLabelSelect').disabled = !this.checked">
                    <label class="form-check-label small">Nest label</label>
                </div>
                <select class="form-select" id="parentLabelSelect" disabled></select>
                <div id="create-error" class="text-danger small mt-2" style="display:none"></div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="btn-create-confirm" onclick="confirmLabelCreation()">Create</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allData = [], filteredData = [], existingLabels = [], pendingActions = {};
    let labelOptionsHTML = "";
    let currentEditingRowEmail = null;
    let isBulkCreate = false;

    // --- INIT ---
    window.onload = async function() {
        fetchUserInfo();
        try {
            const res = await fetch('/api/get_labels');
            existingLabels = await res.json();
            regenerateLabelOptions();
            populateParentLabelSelect();
            populateBulkDropdown();
        } catch(e) {}
        startScanStream();
    };

    async function fetchUserInfo() {
        const res = await fetch('/api/user_info');
        const data = await res.json();
        if(data.name) document.getElementById('user-name').innerText = data.name;
        if(data.picture) document.getElementById('user-avatar').src = data.picture;
        if(data.email) document.getElementById('user-email').innerText = data.email;
    }

    function regenerateLabelOptions() {
        labelOptionsHTML = existingLabels.filter(l => l.type === 'user').map(l => `<option value="label:${l.id}">${l.name}</option>`).join('');
    }

    // --- TABLE & UI ---
    function renderTable() {
        const tbody = document.getElementById('email-table-body');
        tbody.innerHTML = '';
        const pageData = filteredData.slice(0, 50);

        pageData.forEach(row => {
            const tr = document.createElement('tr');
            let val = 'none', cls = '', dis = false;
            
            if (row.processedAction) { val = row.processedAction; cls = 'row-processed'; dis = true; }
            else if (pendingActions[row.email]) { 
                const p = pendingActions[row.email];
                val = p.action === 'delete' ? 'delete' : `label:${p.labelId}`;
            }
            if(cls) tr.className = cls;

            tr.innerHTML = `
                <td><input type="checkbox" class="form-check-input row-checkbox" onchange="updateSelection()" ${dis?'disabled':''}></td>
                <td>${row.email}</td>
                <td class="text-center"><span class="count-badge">${row.count}</span></td>
                <td class="text-end">
                    <select class="form-select form-select-sm action-select d-inline-block w-auto" data-email="${row.email}" onchange="handleActionChange(this)" ${dis?'disabled':''}>
                        <option value="none">Choose...</option>
                        <option value="delete" class="text-danger">Delete</option>
                        <optgroup label="Send to Folder">
                            <option value="new_label">+ Create New Label</option>
                            ${labelOptionsHTML}
                        </optgroup>
                    </select>
                </td>`;
            tr.querySelector('select').value = val;
            tbody.appendChild(tr);
        });
        updateSelection();
    }

    function toggleSelectAll() {
        document.querySelectorAll('.row-checkbox:not(:disabled)').forEach(cb => cb.checked = document.getElementById('selectAll').checked);
        updateSelection();
    }

    function updateSelection() {
        const count = document.querySelectorAll('.row-checkbox:checked').length;
        document.getElementById('bulk-actions-container').style.display = count > 0 ? 'flex' : 'none';
        document.getElementById('search-container').style.display = count > 0 ? 'none' : 'block';
        document.getElementById('selection-count').innerText = `${count} Selected`;
    }

    // --- LOGIC: CREATE LABEL IMMEDIATELY ---
    function populateBulkDropdown() {
        const ul = document.getElementById('bulk-label-dropdown');
        let html = `<li><a class="dropdown-item fw-bold text-primary" href="#" onclick="openBulkCreate()">+ Create New Label</a></li>`;
        html += `<li><hr class="dropdown-divider"></li>` + labelOptionsHTML.replace(/option/g, 'li').replace(/value="/g, 'class="dropdown-item" href="#" onclick="applyBulkRowAction(\'').replace(/">/g, '\')">').replace(/<\/li>/g, '</a></li>');
        ul.innerHTML = html;
    }

    function openBulkCreate() { isBulkCreate = true; document.getElementById('newLabelName').value = ''; new bootstrap.Modal(document.getElementById('labelModal')).show(); }

    async function confirmLabelCreation() {
        const btn = document.getElementById('btn-create-confirm');
        const name = document.getElementById('newLabelName').value;
        const parent = document.getElementById('parentLabelSelect');
        const isNested = document.getElementById('nestLabelCheck').checked;
        if(!name) return;

        btn.disabled = true; btn.innerText = "Creating...";
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

        try {
            const res = await fetch('/api/create_label', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                body: JSON.stringify({name: name, parentId: isNested?parent.value:null, parentName: isNested?parent.options[parent.selectedIndex].text:null})
            });
            const newLabel = await res.json();
            if(newLabel.error) throw new Error(newLabel.error);

            // SUCCESS: Update Global State
            if(!existingLabels.find(l => l.id === newLabel.id)) {
                existingLabels.push({id: newLabel.id, name: newLabel.name, type: 'user'});
                existingLabels.sort((a,b) => a.name.localeCompare(b.name));
            }
            regenerateLabelOptions(); // Update string

            // CRITICAL FIX: Update ALL Dropdowns on page immediately
            document.querySelectorAll('.action-select optgroup').forEach(grp => {
                grp.innerHTML = `<option value="new_label">+ Create New Label</option>` + labelOptionsHTML;
            });
            populateBulkDropdown();

            // APPLY SELECTION
            const labelVal = `label:${newLabel.id}`;
            if(isBulkCreate) {
                applyBulkRowAction(labelVal);
            } else if (currentEditingRowEmail) {
                const sel = document.querySelector(`select[data-email="${currentEditingRowEmail}"]`);
                if(sel) { sel.value = labelVal; handleActionChange(sel); }
            }

            bootstrap.Modal.getInstance(document.getElementById('labelModal')).hide();
            logToConsole(`Created label: ${newLabel.name}`, 'success');

        } catch(e) {
            document.getElementById('create-error').innerText = e.message;
            document.getElementById('create-error').style.display = 'block';
        } finally {
            btn.disabled = false; btn.innerText = "Create";
        }
    }

    function handleActionChange(sel) {
        const val = sel.value;
        const email = sel.dataset.email;
        if(val === 'new_label') {
            currentEditingRowEmail = email; isBulkCreate = false;
            document.getElementById('newLabelName').value = '';
            new bootstrap.Modal(document.getElementById('labelModal')).show();
        } else if (val.startsWith('label:')) {
            const labelId = val.split(':')[1];
            pendingActions[email] = {action: 'label', labelId: labelId, labelName: sel.options[sel.selectedIndex].text};
        } else if (val === 'delete') {
            pendingActions[email] = {action: 'delete'};
        } else { delete pendingActions[email]; }
    }

    function applyBulkRowAction(val) {
        document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
            const tr = cb.closest('tr');
            const sel = tr.querySelector('select');
            sel.value = val;
            handleActionChange(sel);
        });
    }

    // --- OTHER UTILS ---
    function toggleLogs() { document.getElementById('scan-debugger').style.display = 'block'; }
    function logToConsole(msg, type='info') {
        const win = document.getElementById('scan-debugger');
        win.innerHTML += `<div class="log-${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        win.scrollTop = win.scrollHeight;
    }
    
    // ... (Scan Stream & Apply Actions Logic is implied) ...
    function startScanStream() {
        if (scanEventSource) scanEventSource.close();
        scanEventSource = new EventSource("/api/scan_stream");
        scanEventSource.onmessage = e => {
            const data = JSON.parse(e.data);
            if(data.status==='complete') {
                allData = data.data; filteredData = allData; renderTable();
                document.getElementById('hero-status-content').innerHTML = `<h1 class="hero-title" style="margin-top: 10px;">You have <span class="hero-count">${allData.reduce((a,b)=>a+b.count,0)} emails</span> in your inbox.</h1>`;
                scanEventSource.close();
            } else if(data.log) logToConsole(data.log);
        };
    }
    
    async function applyChanges() {
        const btn = document.getElementById('apply-btn');
        if(btn.disabled) return;
        const actions = Object.entries(pendingActions).map(([k,v]) => ({email:k, ...v}));
        if(!actions.length) return alert("No actions selected");
        
        btn.disabled = true; btn.innerText = "Processing...";
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        
        try {
            const res = await fetch('/api/apply_actions', {
                method:'POST', headers:{'Content-Type':'application/json', 'X-CSRFToken':csrfToken}, body:JSON.stringify(actions)
            });
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const lines = decoder.decode(value).split('\n');
                lines.forEach(line => {
                    if(!line) return;
                    const log = JSON.parse(line);
                    if(log.status==='complete') {
                        logToConsole("Complete", 'success');
                        actions.forEach(a => {
                            const row = allData.find(d=>d.email===a.email);
                            if(row) row.processedAction = a.action==='delete'?'delete':`label:${a.labelId}`;
                        });
                        pendingActions = {}; renderTable(); btn.disabled=false; btn.innerText="Apply Actions";
                    } else if(log.msg) logToConsole(log.msg);
                });
            }
        } catch(e) { logToConsole("Error: "+e.message, 'error'); btn.disabled=false; btn.innerText="Apply Actions"; }
    }
    function populateParentLabelSelect() {
        const sel = document.getElementById('parentLabelSelect');
        sel.innerHTML = existingLabels.filter(l=>l.type==='user').map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
    }
    function handleSearch() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        filteredData = allData.filter(d => d.email.includes(q)); renderTable();
    }
</script>
</body>
</html>